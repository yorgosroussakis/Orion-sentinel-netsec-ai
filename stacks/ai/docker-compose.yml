# Orion Sentinel AI Stack
# AI-powered detection, SOAR automation, and web UI for NetSec node
#
# This stack contains only AI services and the web UI.
# Loki and Grafana run separately:
#   - SPoG mode: On CoreSrv (Dell) via LOKI_URL in .env
#   - Standalone mode: Via stacks/nsm/docker-compose.local-observability.yml
#
# All services connect to Loki via LOKI_URL environment variable.

version: '3.8'

services:
  # SOAR Service
  soar:
    build:
      context: ../..
      dockerfile: stacks/ai/Dockerfile
    container_name: orion-soar
    command: python -m orion_ai.soar.service
    environment:
      - LOKI_URL=${LOKI_URL}
      - SOAR_DRY_RUN=1
      - SOAR_POLL_INTERVAL=60
      - SOAR_PLAYBOOKS_FILE=/config/playbooks.yml
      - SOAR_ALLOW_EMPTY_PLAYBOOKS=0
      - PIHOLE_URL=http://192.168.1.2
      - PIHOLE_API_KEY=${PIHOLE_API_KEY}
      - LOG_LEVEL=INFO
    volumes:
      - ../../config:/config:ro
      - soar-data:/data
    restart: unless-stopped
    networks:
      - orion-network

  # Device Inventory Service
  inventory:
    build:
      context: ../..
      dockerfile: stacks/ai/Dockerfile
    container_name: orion-inventory
    command: python -m orion_ai.inventory.service
    environment:
      - LOKI_URL=${LOKI_URL}
      - INVENTORY_POLL_INTERVAL=300
      - INVENTORY_DB_PATH=/data/inventory.db
      - LOG_LEVEL=INFO
    volumes:
      - inventory-data:/data
    restart: unless-stopped
    networks:
      - orion-network

  # Change Monitor Service
  change-monitor:
    build:
      context: ../..
      dockerfile: stacks/ai/Dockerfile
    container_name: orion-change-monitor
    command: python -m orion_ai.change_monitor.service
    environment:
      - LOKI_URL=${LOKI_URL}
      - CHANGE_MONITOR_INTERVAL_HOURS=24
      - CHANGE_MONITOR_PERIOD_DAYS=7
      - LOG_LEVEL=INFO
    volumes:
      - change-data:/data
    restart: unless-stopped
    networks:
      - orion-network

  # Health Score Service
  health-score:
    build:
      context: ../..
      dockerfile: stacks/ai/Dockerfile
    container_name: orion-health-score
    command: python -m orion_ai.health_score.service
    environment:
      - LOKI_URL=${LOKI_URL}
      - HEALTH_SCORE_INTERVAL_HOURS=1
      - LOG_LEVEL=INFO
    volumes:
      - health-data:/data
    restart: unless-stopped
    networks:
      - orion-network

  # API Server / Web UI
  # In normal SPoG mode, this UI is exposed via Traefik on CoreSrv
  # (e.g., https://security.local), which proxies to this service on the NetSec node.
  # Port 8000 should be accessible from CoreSrv's Traefik instance over LAN.
  api:
    build:
      context: ../..
      dockerfile: stacks/ai/Dockerfile
    container_name: orion-api
    command: python -m orion_ai.ui.http_server
    environment:
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - API_RELOAD=false
      - LOKI_URL=${LOKI_URL}
      - LOG_LEVEL=INFO
    ports:
      - "8000:8000"
    volumes:
      - inventory-data:/data:ro
    restart: unless-stopped
    depends_on:
      - inventory
    networks:
      - orion-network

volumes:
  soar-data:
  inventory-data:
  change-data:
  health-data:

networks:
  orion-network:
    driver: bridge
